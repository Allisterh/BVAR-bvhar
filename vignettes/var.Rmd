---
title: "VAR and VHAR"
output: rmarkdown::html_vignette
header-includes:
- \newcommand{\R}{\mathbb{R}}
- \newcommand{\B}{\boldsymbol\beta}
- \newcommand{\hb}{\boldsymbol{\hat\beta}}
- \newcommand{\E}{\boldsymbol\epsilon}
- \DeclareMathOperator*{\argmin}{argmin}
- \DeclareMathOperator*{\argmax}{argmax}
- \newcommand{\defn}{\mathpunct{:}=}
- \newcommand{\X}{\mathbf{X}}
- \newcommand{\Y}{\mathbf{Y}}
- \newcommand{\by}{\mathbf{y}}
- \newcommand{\bz}{\mathbf{Z}}
- \newcommand{\ba}{\boldsymbol{\alpha}}
- \newcommand{\bc}{\mathbf{c}}
- \newcommand{\bu}{\mathbf{u}}
- \def\Cov{\mathrm{Cov}}
- \def\Var{\mathrm{Var}}
- \def\Corr{\mathrm{Corr}}
- \def\vec{\mathrm{vec}}
vignette: >
  %\VignetteIndexEntry{VAR and VHAR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = .618,
  fig.pos = "H"
  )
options(digits = 3)
```

```{r pkgs}
library(bvhar)
```

```{r addpkgs, message=FALSE}
# for this vignette--------------
library(dplyr)
```

# Simple Setting

Looking at VAR and VHAR, you can learn how the models work and how to perform this package.

## ETF Dataset

This package includes some datasets.
Among them, we try CBOE ETF volatility index (`etf_vix`).
Since this is just an example, we aribitrarily extract a small number of variables: *Gold, crude oil, euro currency, and china ETF*.

```{r etfdat}
var_idx <- c("GVZCLS", "OVXCLS", "EVZCLS", "VXFXICLS")
etf <- 
  etf_vix %>% 
  select(all_of(var_idx))
etf
```

## Out-of-sample

For out-of-sample forecasting, split the data.
The last `19` observations will be test set.

```{r outofsample}
h <- 19
# train-------------
etf_train <- 
  etf %>% 
  slice(seq_len(n() - h))
# test--------------
etf_test <- setdiff(etf, etf_train)
# dimension---------
m <- ncol(etf)
```

- n: Total number of observation
- p: VAR lag
- m: Dimension of variable
- s = n - p
- k = m * p + 1

# VAR

This package indentifies VAR(p) model by

$$\Y_t = \bc + B_1 \Y_{t - 1} + \ldots + \B_p +\Y_{t - p} + \E_t$$

where $\E_t \sim N(\mathbf{0}_k, \Sigma_e)$

## Fit

```{r varlag}
var_lag <- 5
```

The package perform VAR(p = `r var_lag`) based on

$$Y_0 = X_0 B + Z$$

where

$$
Y_0 = \begin{bmatrix}
  \by_{p + 1}^T \\
  \by_{p + 2}^T \\
  \vdots \\
  \by_n^T
\end{bmatrix}_{s \times m} \equiv Y_{p + 1} \in \R^{s \times m}
$$

by `build_y0()`

and

$$
X_0 = \left[\begin{array}{c|c|c|c}
  \by_p^T & \cdots & \by_1^T & 1 \\
  \by_{p + 1}^T & \cdots & \by_2^T & 1 \\
  \vdots & \vdots & \cdots & \vdots \\
  \by_{n - 1}^T & \cdots & \by_{n - p}^T & 1
\end{array}\right]_{s \times k} = \begin{bmatrix}
  Y_p & Y_{p - 1} & \cdots & \mathbf{1}_{n - p}
\end{bmatrix} \in \R^{s \times k}
$$

by `build_design()`. Then

```{r}
(fit_var <- var_lm(etf_train, var_lag))
```

The package provide `S3` object.

```{r}
# class---------------
class(fit_var)
# inheritance---------
is.varlse(fit_var)
# names---------------
names(fit_var)
```

### Coefficient matrices

You can see the estimate for coefficient matrix of the form

$$
B = \begin{bmatrix}
  B_1^T \\
  \vdots \\
  B_p^T \\
  \bc^T
\end{bmatrix} \in \R^{k \times m}
$$

Extract $\hat{B}$ corresponding to the above form:

```{r}
coef(fit_var)
```

### Fitted values

$\hat{Y}_0 = X_0 \hat{B}$:

```{r}
fitted(fit_var) %>% 
  head()
```

### Residuals

$Y_0 - X_0 \hat{B}$:

```{r}
resid(fit_var) %>% 
  head()
```

## Summary

For more information, use `summary()` function.

```{r}
summary(fit_var)
```

## Select the Model

Explore information criteria up to `lag_max`.

```{r}
choose_var(etf_train, 10)
```

In VAR literature, BIC is quite safe suggestion, so in this document, we try VAR(1).

```{r}
fit_best <- var_lm(etf_train, 1)
```

## Forecasting

In VAR modeling, `vars` package is famous.
We refer to its argument `n.ahead` and you can forecast using `predict()` method with above `varlse` object.

```{r}
(pred_var <- predict(fit_best, n.ahead = h))
```

```{r}
class(pred_var)
names(pred_var)
```

```{r}
autoplot(pred_var, x_cut = 500)
```

The package provides the evaluation function that computes MSE: `mse(predbvhar, test)`.
Compute MSE as follow:

```{r}
(mse_var <- mse(pred_var, etf_test))
```


# VHAR

Consider Vector HAR (VHAR) model.

$$\Y_t = \bc + \Phi^{(d)} + \Y_{t - 1} + \Phi^{(w)} \Y_{t - 1}^{(w)} + \Phi^{(m)} \Y_{t - 1}^{(m)} + \E_t$$

where $\Y_t$ is daily RV and

$$\Y_t^{(w)} = \frac{1}{5} \left( \Y_t + \cdots + \Y_{t - 4} \right)$$

is weekly RV

and

$$\Y_t^{(m)} = \frac{1}{22} \left( \Y_t + \cdots + \Y_{t - 21} \right)$$

is monthly RV. This model can be expressed by

$$Y_0 = X_1 \Phi + Z$$

where

$$
\Phi = \begin{bmatrix}
  \Phi^{(d)T} \\
  \Phi^{(w)T} \\
  \Phi^{(m)T} \\
  \bc^T
\end{bmatrix} \in \R^{(3m + 1) \times m}
$$

Let $T$ be

$$
T \defn \begin{bmatrix}
  1 & 0 & \cdots & 0 & 0 & \cdots & 0 \\
  1 / 5 & 1 / 5 & \cdots & 1 / 5 & 0 & \cdots & 0 \\
  1 / 22 & 1 / 22 & \cdots & 1 / 22 & 1 / 22 & \cdots & 1 / 22
\end{bmatrix} \otimes I_m \in \R^{3m \times 22m}
$$

and let $\widetilde{T}$ be

$$
\widetilde{T} \defn \left[\begin{array}{c|c}
  T & \mathbf{0}_{3m} \\ \hline
  \mathbf{0}_{3m}^T & 1
\end{array}\right] \in \R^{(3m + 1) \times (22m + 1)}
$$

Then for $X_0$ in VAR(p),

$$
X_1 = X_0 \widetilde{T}^T = \begin{bmatrix}
  \by_{22}^T & \by_{22}^{(w)T} & \by_{22}^{(m)T} & 1 \\
  \by_{23}^T & \by_{23}^{(w)T} & \by_{23}^{(m)T} & 1 \\
  \vdots & \vdots & \vdots & \vdots \\
  \by_{n - 1}^T & \by_{n - 1}^{(w)T} & \by_{n - 1}^{(m)T} & 1
\end{bmatrix} \in \R^{s \times (3m + 1)}
$$

This package fits VHAR by scaling VAR(p) using $\widetilde{T}$ (`scale_har(m)`).

## Fit

```{r}
(fit_har <- vhar_lm(etf_train))
```

```{r}
# class----------------
class(fit_har)
# inheritance----------
is.varlse(fit_har)
is.vharlse(fit_har)
# complements----------
names(fit_har)
```


## Forecasting

VHAR also follows `varlse` basically. Use `predict` method with `n.ahead` option.

```{r}
(pred_har <- predict(fit_har, n.ahead = h))
```

```{r}
autoplot(pred_har, x_cut = 500)
```

MSE:

```{r}
(mse_har <- mse(pred_har, etf_test))
```

Compare the two MSE:

```{r}
# VAR-------------
mean(mse_var)
# VHAR------------
mean(mse_har)
```

